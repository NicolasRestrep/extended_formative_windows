
# cleaning/clean_anes_16_20.R

source("code/cleaning/utils.R")


clean_anes_16_20 <- function(path) {
  
  anes16 <- read_sav(path) %>%
    zap_labels()
  
  cleaned <- anes16 %>%
    mutate(id = row_number()) %>%
    select(id, V161267, V201507x,
           V160102,#weight for pre- and post 2016 
           V200011a, #weight for pre-16 and pre-20 combined
           V200011b, #weight for post-16 and post-20 combined
           V164002, V165002, V203053, V203078,
           V161158x, V201231x,
           V161126, V162171, V201200,
           V161153, V201347,
           V161217, V201235,
           V161216, V201234,
           V161189, V201255,
           V161184, V201252,
           V161198, V201258,
           V161232, V201336,
           V161178, V201246,
           V161181, V201249,
           V161212, V201321,
           V161205, V201300,
           V161206, V201303,
           V161209, V201312,
           V161208, V201309,
           V161211, V201318,
           V161095, V201156,
           V161096, V201157,
           V162312, V202480,
           V162314, V202482,
           V162101, V202164,
           V162097, V202161,
           V162100, V202163,
           V162098, V202162,
           V162311, V202479,
           V162103, V202166,
           V162108, V202170,
           V162110, V202171, 
           # Attention Campaigns
           V161004, V201006, 
           # People like me Likert
           V162216, V202213, 
           # Spend Poor 
           V161211, V201318,
           # Less gvt 
           V162185, V202253, 
           # Preferential hiring
           V162238, V202249,
           # Death penalty
           V161233, V201343,
           # Number of migrants
           V162157, V202232,
           # Favor Oppose Homo
           V161229, V201412,
           # T: asian-americans
           V162310, V202477,
           # T: feminists
           V162096, V202160,
           # T: illegal immigrants
           V162313, V202481,
           # T: Equality of opportunity for success
           V162243, V202260,
           # Worry less equality
           V162244, V202261,
           # Unequal no problem
           V162245, V202262,
           # Equality less problem
           V162246, V202263,
           # Moral Relativity
           V162207, V202264,
           # Traditional family
           V162210, V202265,
           # Hard work whites
           V162345, V202515,
           # Hard work blk 
           V162346, V202516,
           # Slavery difficulty
           V162212, V202301,
           # Blacks no favors
           V162211, V202300,
           # Matter of Hard work
           V162214, V202303,
           # Religious importance
           V161241, V201433,
           # Dont care (2,4; 5pt; NA < -9,-7,-6; -8=3)
           V162215, V202212,
           # elexmatter (1,2,3; NA <0)
           V161220, V201238,
           # Satisfied with democracy (1,2,4,5, recode to 1234)
           V162290, V202440
    ) %>%
    mutate(age_1 = ifelse(V161267 < 0 & V201507x > 0, V201507x, ifelse(V161267 < 0, NA, V161267)),
           age_2 = age_1,
           age_3 = ifelse(!is.na(age_1) & V201507x < 0, age_1 + 4, V201507x),
           age_4 = age_3,
           across(age_1:age_4, ~as.character(.x))) %>%
    mutate(weight_2 = as.character(V160102),
           weight_3 = as.character(V200011a), 
           weight_4 = as.character(V200011b)) %>%
    mutate(date_1 = convert_to_date(V164002),
           date_2 = convert_to_date(V165002),
           date_3 = convert_to_date(V203053),
           date_4 = convert_to_date(V203078),
           across(c(V162215, V202212,
                    V162216, V202213),
                  ~recode(.x, "1"=1, "2"=1, "3"=3,
                          "4"=5, "5"=5, "-8"=3,
                          "-9"=NA_real_, "-6"=NA_real_,
                          "-4"=NA_real_, "-5"=NA_real_)),
           across(c(V162290, V202440),
                  ~recode(.x, "1"=1, "2"=2, "4"=3, "5"=4,
                          "-5"=NA_real_, "-6"=NA_real_,
                          "-7"=NA_real_, "-8"=NA_real_,
                          "-9"=NA_real_)),
           across(c(V161095, V201156,
                    V161096, V201157,
                    V162312, V202480,
                    V162314, V202482,
                    V162101, V202164,
                    V162097, V202161,
                    V162100, V202163,
                    V162098, V202162,
                    V162311, V202479,
                    V162103, V202166,
                    V162108, V202170,
                    V162110, V202171, 
                    V162310, V202477, 
                    V162096, V202160,
                    V162313, V202481),
                  ~ifelse(.x < 0 | .x > 100, NA, .x)),
           across(c(V161158x, V201231x,
                    V161126, V162171, V201200,
                    V161153, V201347,
                    V161217, V201235,
                    V161216, V201234, 
                    V161189, V201255,
                    V161184, V201252,
                    V161198, V201258,
                    V161178, V201246,
                    V161181, V201249, 
                    V161004, V201006,
                    V162157, V202232,
                    V162243, V202260,
                    V162244, V202261,
                    V162245, V202262,
                    V162246, V202263,
                    V162207, V202264,
                    V162210, V202265,
                    V162345, V202515, 
                    V162346, V202516,
                    V162212, V202301,
                    V162211, V202300, 
                    V162214, V202303),
                  ~ifelse(.x < 0 | .x > 7, NA, .x)),
           across(c(V161232, V201336, 
                    V161211, V201318, 
                    V162185, V202253,
                    V162238, V202249,
                    V161233, V201343,
                    V161229, V201412,
                    V161241, V201433,
                    V161220, V201238),
                  ~ifelse(.x < 0 | .x > 4, NA, .x)),
           across(c(V161212, V201321,
                    V161205, V201300,
                    V161206, V201303,
                    V161209, V201312,
                    V161208, V201309,
                    V161211, V201318),
                  ~ifelse(.x == 3, 1.5, ifelse(.x < 0, NA, .x))),
           partyid_1 = as.character(V161158x),
           partyid_3 = as.character(V201231x),
           polviews_1 = as.character(V161126),
           polviews_2 = as.character(V162171),
           polviews_3 = as.character(V201200),
           stayhome_1 = as.character(V161153), 
           stayhome_3 = as.character(V201347),
           wastetax_1 = as.character(V161217), 
           wastetax_3 = as.character(V201235),
           runfew_1 = as.character(V161216), 
           runfew_3 = as.character(V201234),
           jobguar_1 = as.character(V161189), 
           jobguar_3 = as.character(V201255),
           govins_1 = as.character(V161184), 
           govins_3 = as.character(V201252),
           helpblk_1 = as.character(V161198), 
           helpblk_3 = as.character(V201258),
           abortion_1 = as.character(V161232), 
           abortion_3 = as.character(V201336),
           spendserv_1 = as.character(V161178), 
           spendserv_3 = as.character(V201246),
           defscale_1 = as.character(V161181), 
           defscale_3 = as.character(V201249),
           natenvir_1 = as.character(V161212), 
           natenvir_3 = as.character(V201321),
           natsoc_1 = as.character(V161205), 
           natsoc_3 = as.character(V201300),
           natschools_1 = as.character(V161206), 
           natschools_3 = as.character(V201303),
           natfare_1 = as.character(V161209), 
           natfare_3 = as.character(V201312),
           natcrime_1 = as.character(V161208),
           natcrime_3 = as.character(V201309),
           natpoor_1 = as.character(V161211), 
           natpoor_3 = as.character(V201318),
           ftdems_1 = as.character(V161095), 
           ftdems_3 = as.character(V201156),
           ftreps_1 = as.character(V161096), 
           ftreps_3 = as.character(V201157),
           ftblacks_2 = as.character(V162312), 
           ftblacks_4 = as.character(V202480),
           ftwhites_2 = as.character(V162314), 
           ftwhites_4 = as.character(V202482),
           ftcons_2 = as.character(V162101), 
           ftcons_4 = as.character(V202164),
           ftlibs_2 = as.character(V162097), 
           ftlibs_4 = as.character(V202161),
           ftbiz_2 = as.character(V162100), 
           ftbiz_4 = as.character(V202163),
           ftlabor_2 = as.character(V162098), 
           ftlabor_4 = as.character(V202162),
           fthisp_2 = as.character(V162311), 
           fthisp_4 = as.character(V202479),
           fthomo_2 = as.character(V162103), 
           fthomo_4 = as.character(V202166),
           ftjews_2 = as.character(V162108), 
           ftjews_4 = as.character(V202170),
           ftcops_2 = as.character(V162110), 
           ftcops_4 = as.character(V202171),
           attentioncpg_1 = as.character(V161004),
           attentioncpg_3 = as.character(V201006),
           ppllikeme_2 = as.character(V162216),
           ppllikeme_4 = as.character(V202213), 
           natpoor_1 = as.character(V161211),
           natpoor_3 = as.character(V201318),
           lessgvt_2 = as.character(V162185),
           lessgvt_4 = as.character(V202253),
           prefhiring_2 = as.character(V162238), 
           prefhiring_4 = as.character(V202249),
           cappun_1 = as.character(V161233), 
           cappun_3 = as.character(V201343),
           letin1a_2 = as.character(V162157), 
           letin1a_4 = as.character(V202232), 
           opposehomo_1 = as.character(V161229), 
           opposehomo_3 = as.character(V201412),
           ftasianamericans_2 = as.character(V162310),
           ftasianamericans_4 = as.character(V202477),
           ftfeminists_2 = as.character(V162096), 
           ftfeminists_4 = as.character(V202160),
           ftillimmigrants_2 = as.character(V162313),
           ftillimmigrants_4 = as.character(V202481),
           eqoppsuccess_2 = as.character(V162243),
           eqoppsuccess_4 = as.character(V202260),
           worrylesseq_2 = as.character(V162244),
           worrylesseq_4 = as.character(V202261),
           unequalnoprob_2 = as.character(V162245),
           unequalnoprob_4 = as.character(V202262),
           equallessprob_2 = as.character(V162246),
           equallessprob_4 = as.character(V202263),
           moralrel_2 = as.character(V162207),
           moralrel_4 = as.character(V202264),
           tradfamily_2 = as.character(V162210),
           tradfamily_4 = as.character(V202265),
           hrdwrklazywhite_2 = as.character(V162345),
           hrdwrklazywhite_4 = as.character(V202515),
           hrdwrklazyblack_2 = as.character(V162346),
           hrdwrklazyblack_4 = as.character(V202516),
           slavediff_2 = as.character(V162212),
           slavediff_4 = as.character(V202301),
           wrkwayup_2 = as.character(V162211),
           wrkwayup_4 = as.character(V202300),
           matterhrdwrk_2 = as.character(V162214),
           matterhrdwrk_4 = as.character(V202303),
           # Dont care (2,4; 5pt; NA < -9,-7,-6; -8=3)
           dontcare_2 = as.character(V162215), 
           dontcare_4 = as.character(V202212),
           # elexmatter (1,2,3; NA <0)
           elexmatter_2 = as.character(V161220), 
           elexmatter_4 = as.character(V201238),
           # Satisfied with democracy (1,2,4,5, recode to 1234)
           satdemo_2 = as.character(V162290), 
           satdemo_4 = as.character(V202440)
    ) %>% 
    select(id, weight_2:weight_4, age_1:age_4, date_1:satdemo_4) %>%
    pivot_longer(weight_2:satdemo_4) %>%
    separate(name, into = c("measure", "wave")) %>%
    spread(measure, value) %>%
    mutate(date = as.Date(date),
           across(c(weight, abortion:cappun, defscale:wrkwayup),
                  ~as.numeric(.x)),
           across(c(partyid, polviews, jobguar,
                    govins, helpblk, spendserv,
                    defscale, hrdwrklazywhite, hrdwrklazyblack),
                  ~(.x-1)/6*100),
           across(c(stayhome, runfew,
                    natenvir, natsoc, natschools, natfare,
                    natcrime, natpoor, lessgvt, prefhiring,
                    cappun, opposehomo),
                  ~(.x-1)*100),
           across(c(wastetax, attentioncpg,
                    elexmatter),
                  ~(.x-1)/2*100),
           across(c(abortion, satdemo),
                  ~(.x-1)/3*100), 
           across(c(ppllikeme, letin1a,
                    eqoppsuccess, worrylesseq,
                    unequalnoprob, equallessprob,
                    moralrel, tradfamily,
                    slavediff, wrkwayup,
                    matterhrdwrk, 
                    dontcare), 
                  ~(.x-1)/4*100)) %>%
    pivot_longer(c(abortion, attentioncpg:cappun, defscale:wastetax, worrylesseq:wrkwayup)) %>%
    filter(!is.na(age), !is.na(value), !is.na(date)) %>% arrange(id, name, date) %>%
    mutate(df = "2016-20 ANES")
  
  return(cleaned)
}