#  ungroup() %>%
#  mutate(dec_diff = (as.numeric(difftime(date, min(date), units = "days")))/3652.5,
#         d = as.numeric(d)) %>%
#Combine the data sets to a long "raw score"
#data frame first
long_scores <- bind_rows(anes5_long, anes7_long, anes8_long,
anes90_long, anes9_long, anes0_long,
gss6_long, gss8_long, gss10_long,
gss20_long, anes16_long, anes20_long) %>%
group_by(id, name, df) %>%
mutate(nobs = n()) %>% filter(nobs > 1) %>% ungroup()
# Need Cleaning
# 1990-92 ANES matterhrdwrk
#Then combine them to calculate difference scores
#This calculation takes a very long time, I'm
#sure there's some way to speed it up. But I think it's
#better having this code be parsimonious/not replicating
#with each panel.
long_difference <- long_scores %>%
mutate(
i1_value = lead(id),
i2_value = lead(id,2),
i3_value = lead(id,3),
i4_value = lead(id,4),
i5_value = lead(id,5),
i6_value = lead(id,6),
n1_value = lead(name),
n2_value = lead(name,2),
n3_value = lead(name,3),
n4_value = lead(name,4),
n5_value = lead(name,5),
n6_value = lead(name,6),
#Get weight from second observation
w1_value = lead(weight),
w2_value = lead(weight,2),
w3_value = lead(weight,3),
w4_value = lead(weight,4),
w5_value = lead(weight,5),
w6_value = lead(weight,6),
#Note second wave number
t1_value = lead(wave),
t2_value = lead(wave,2),
t3_value = lead(wave,3),
t4_value = lead(wave,4),
t5_value = lead(wave,5),
t6_value = lead(wave,6),
#Calculate duration between waves
d1_value = lead(date) - date,
d2_value = lead(date,2) - date,
d3_value = lead(date,3) - date,
d4_value = lead(date,4) - date,
d5_value = lead(date,5) - date,
d6_value = lead(date,6) - date,
#Calculate absolute difference between waves
a1_value = abs(value - lead(value)),
a2_value = abs(value - lead(value,2)),
a3_value = abs(value - lead(value,3)),
a4_value = abs(value - lead(value,4)),
a5_value = abs(value - lead(value,5)),
a6_value = abs(value - lead(value,6))) %>%
pivot_longer(
cols = c(i1_value, i2_value, i3_value, i4_value, i5_value, i6_value,
n1_value, n2_value, n3_value, n4_value, n5_value, n6_value,
t1_value, t2_value, t3_value, t4_value, t5_value, t6_value,
w1_value, w2_value, w3_value, w4_value, w5_value, w6_value,
d1_value, d2_value, d3_value, d4_value, d5_value, d6_value,
a1_value, a2_value, a3_value, a4_value, a5_value, a6_value),
names_to = c(".value", "set"),
names_pattern = "(.)(.)_value") %>%
filter(!is.na(a)) %>%
mutate(d = d/365.25) %>%
filter(id == i, name == n) %>%
select(-c(i,n)) %>%
mutate(t1 = wave, t2 = t, duration = d, abs_diff = a, weight = w) %>%
select(df, id, weight, name, t1, t2, date, age, duration, abs_diff, value) %>%
mutate(age_group = ifelse(age < 26, "18-25", "34-65"),
age_group = ifelse(age > 25 & age < 34, "26-33", age_group),
age_group = ifelse(age > 65, "65+", age_group))
long_difference %>% group_by(name, df) %>% summarise(meana = mean(abs_diff)) %>% View()
# Save dataset ====
#save(long_data, file = "~/Dropbox/extended_formative_windows/clean_data/long_data.Rdata")
save(long_difference, file = "~/Dropbox/extended_formative_windows/clean_data/long_difference.Rdata")
# cappun has a midpoint in the 90-92 and 92-97 scales, but not in the GSS panels
# and then has it in the 16-20 ANEs
#Panel summaries
psummaries <- long_difference %>%
mutate(wave_pair = paste(t1, t2, df, sep = "-")) %>%
group_by(name, df) %>%
summarise(d = weighted.mean(duration), a = weighted.mean(abs_diff),
date = weighted.mean(date), n = n(), sd = sd(abs_diff)) %>%
#Filtering out bad questions
filter(name != "natpoor",
name != "nathome") %>% ungroup() %>%
mutate(dec_diff = (as.numeric(difftime(date, max(date), units = "days")))/3652.5) %>%
mutate(se = sd/sqrt(n))
View(long_scores)
#Panel summaries
psummaries <- long_difference %>%
mutate(wave_pair = paste(t1, t2, df, sep = "-")) %>%
group_by(name, df) %>%
summarise(d = weighted.mean(duration), a = weighted.mean(abs_diff),
date = weighted.mean(date), n = n(), sd = sd(abs_diff)) %>%
#Filtering out bad questions
filter(name != "natpoor",
name != "nathome") %>% ungroup() %>%
mutate(dec_diff = (as.numeric(difftime(date, max(date), units = "days")))/3652.5) %>%
mutate(se = sd/sqrt(n))
View(psummaries)
anes90$V900509
anes90_long %>% filter(name == "ppllikeme") %>% ggplot(aes(x = value)) + geom_histogram() + facet_wrap(`wave`)
anes90_long %>% filter(name == "ppllikeme") %>% ggplot(aes(x = value)) + geom_histogram() + facet_wrap(~wave)
anes90$V900509
anes90$V912489
anes90$V926102
#Panel summaries
psummaries <- long_difference %>%
mutate(wave_pair = paste(t1, t2, df, sep = "-")) %>%
group_by(name, df) %>%
summarise(d = weighted.mean(duration), a = weighted.mean(abs_diff),
date = weighted.mean(date), n = n(), sd = sd(abs_diff)) %>%
#Filtering out bad questions
filter(name != "natpoor",
name != "nathome") %>% ungroup() %>%
mutate(dec_diff = (as.numeric(difftime(date, max(date), units = "days")))/3652.5) %>%
mutate(se = sd/sqrt(n))
View(psummaries)
# Summarize absolute difference at the wave-pair level for each age group
# for each question.
summaries <- long_difference %>%
mutate(wave_pair = paste(t1, t2, df, sep = "-")) %>%
group_by(wave_pair, name, age_group) %>%
summarise(d = weighted.mean(duration), a = weighted.mean(abs_diff),
date = weighted.mean(date), n = n(), sd = sd(abs_diff)) %>%
#Filtering out bad questions
filter(name != "natpoor",
name != "nathome") %>% ungroup() %>%
mutate(dec_diff = (as.numeric(difftime(date, max(date), units = "days")))/3652.5) %>%
mutate(se = sd/sqrt(n))
# Multilevel model
m1 <- lmer(a ~ d + dec_diff + age_group + dec_diff*age_group +
(1 + d + dec_diff + age_group + dec_diff*age_group|name),
data = summaries %>% filter(sd > 0), weights = 1/se)
# Data to predict
new.data <- expand_grid(age_group = c(unique(summaries$age_group)),
dec_diff = seq(-6.4, 0, by = .1),
d = 0, name = unique(summaries$name))
#Predict data
new.data$yhat <- predict(m1, newdata = new.data)
#Graph predictions
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
mutate(year = as.Date("2020-11-12") + dec_diff*3652.5) %>%
ggplot(aes(x = year, y = yhat, color = age_group)) +
geom_hline(yintercept = 0, color = "black") +
geom_line(alpha = .2, aes(group = group)) +
geom_smooth(linewidth = 2) +
theme_bw() +
facet_wrap(~age_group) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group",
title = "Predicted wave-to-wave change by age group",
subtitle = "Individual question trajectories and overall trajectory") +
scale_color_brewer(type = "qual", palette = 2) +
theme(legend.position = "none")
#Look at questions instead
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
ggplot(aes(x = dec_diff, y = yhat, color = age_group)) +
geom_point(data = summaries, aes(y = a)) +
geom_line(alpha = .7, aes(group = group)) +
theme_bw() +
facet_wrap(~name) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group")
summary(m1)
test <- tidy(m1) %>%
filter(effect == "fixed") %>%
mutate(fe = estimate) %>%
select(term, fe)
augment(ranef(m1, condVar = TRUE)) %>%
left_join(test, by = c("variable"="term")) %>%
mutate(estimate = estimate + fe, lb = lb + fe, ub = ub + fe) %>%
ggplot(aes(x = estimate, y = level, xmin = lb, xmax = ub)) +
geom_vline(xintercept = 0, linetype = 2) +
geom_vline(data = tidy(fixef(m1)) %>% mutate(variable = names, estimate = x),
aes(xintercept = estimate), color = "firebrick", linetype = 2) +
geom_linerange() +
geom_point() +
facet_grid(.~variable, scales = "free_x") +
theme_bw()
#Look at questions instead
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
ggplot(aes(x = dec_diff, y = yhat, color = age_group)) +
geom_point(data = summaries, aes(y = a)) +
geom_line(alpha = .7, aes(group = group)) +
theme_bw() +
facet_wrap(~name) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group")
# Summarize absolute difference at the wave-pair level for each age group
# for each question.
summaries <- long_difference %>%
mutate(wave_pair = paste(t1, t2, df, sep = "-")) %>%
group_by(wave_pair, name, age_group) %>%
summarise(d = weighted.mean(duration), a = weighted.mean(abs_diff),
date = weighted.mean(date), n = n(), sd = sd(abs_diff)) %>%
#Filtering out bad questions
filter(name != "natpoor",
name != "nathome") %>% ungroup() %>%
mutate(dec_diff = (as.numeric(difftime(date, max(date), units = "days")))/3652.5) %>%
mutate(se = sd/sqrt(n)) %>%
mutate(name = ifelse(name == "nateduc", "natschools", name))
# Multilevel model
m1 <- lmer(a ~ d + dec_diff + age_group + dec_diff*age_group +
(1 + d + dec_diff + age_group + dec_diff*age_group|name),
data = summaries %>% filter(sd > 0), weights = 1/se)
# Data to predict
new.data <- expand_grid(age_group = c(unique(summaries$age_group)),
dec_diff = seq(-6.4, 0, by = .1),
d = 0, name = unique(summaries$name))
#Predict data
new.data$yhat <- predict(m1, newdata = new.data)
#Graph predictions
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
mutate(year = as.Date("2020-11-12") + dec_diff*3652.5) %>%
ggplot(aes(x = year, y = yhat, color = age_group)) +
geom_hline(yintercept = 0, color = "black") +
geom_line(alpha = .2, aes(group = group)) +
geom_smooth(linewidth = 2) +
theme_bw() +
facet_wrap(~age_group) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group",
title = "Predicted wave-to-wave change by age group",
subtitle = "Individual question trajectories and overall trajectory") +
scale_color_brewer(type = "qual", palette = 2) +
theme(legend.position = "none")
#Look at questions instead
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
ggplot(aes(x = dec_diff, y = yhat, color = age_group)) +
geom_point(data = summaries, aes(y = a)) +
geom_line(alpha = .7, aes(group = group)) +
theme_bw() +
facet_wrap(~name) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group")
test <- tidy(m1) %>%
filter(effect == "fixed") %>%
mutate(fe = estimate) %>%
select(term, fe)
augment(ranef(m1, condVar = TRUE)) %>%
left_join(test, by = c("variable"="term")) %>%
mutate(estimate = estimate + fe, lb = lb + fe, ub = ub + fe) %>%
ggplot(aes(x = estimate, y = level, xmin = lb, xmax = ub)) +
geom_vline(xintercept = 0, linetype = 2) +
geom_vline(data = tidy(fixef(m1)) %>% mutate(variable = names, estimate = x),
aes(xintercept = estimate), color = "firebrick", linetype = 2) +
geom_linerange() +
geom_point() +
facet_grid(.~variable, scales = "free_x") +
theme_bw()
#Look at questions instead
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
ggplot(aes(x = dec_diff, y = yhat, color = age_group)) +
geom_point(data = summaries, aes(y = a)) +
geom_line(alpha = .7, aes(group = group)) +
theme_bw() +
facet_wrap(~name) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group")
#Graph predictions
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
mutate(year = as.Date("2020-11-12") + dec_diff*3652.5) %>%
ggplot(aes(x = year, y = yhat, color = age_group)) +
geom_hline(yintercept = 0, color = "black") +
geom_line(alpha = .2, aes(group = group)) +
geom_smooth(linewidth = 2) +
theme_bw() +
facet_wrap(~age_group) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group",
title = "Predicted wave-to-wave change by age group",
subtitle = "Individual question trajectories and overall trajectory") +
scale_color_brewer(type = "qual", palette = 2) +
theme(legend.position = "none")
test
tidy(m1) %>%
filter(effect == "fixed") %>%
mutate(fe = estimate)
tidy(m1) %>%
filter(effect == "fixed") %>%
mutate(fe = estimate) %>%
select(term, fe)
tidy(fixef(m1))
#Look at questions instead
new.data %>%
filter(age_group == "65+") %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
ggplot(aes(x = dec_diff, y = yhat, color = age_group)) +
geom_point(data = summaries, aes(y = a)) +
geom_line(alpha = .7, aes(group = group)) +
theme_bw() +
facet_wrap(~name) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group")
#Look at questions instead
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
ggplot(aes(x = dec_diff, y = yhat, color = age_group)) +
geom_point(data = summaries, aes(y = a)) +
geom_line(alpha = .7, aes(group = group)) +
theme_bw() +
facet_wrap(~name) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group")
summary(m1)
ranef(m1)
tidy(ranef(m1))
ranef(m1)$name
ranef(m1)$name$`(Intercept)`
hist(ranef(m1)$name$`(Intercept)`)
summary(m1)
augment(ranef(m1, condVar = TRUE)) %>%
left_join(test, by = c("variable"="term")) %>%
mutate(estimate = estimate + fe, lb = lb + fe, ub = ub + fe) %>%
ggplot(aes(x = estimate, y = level, xmin = lb, xmax = ub)) +
geom_vline(xintercept = 0, linetype = 2) +
geom_vline(data = tidy(fixef(m1)) %>% mutate(variable = names, estimate = x),
aes(xintercept = estimate), color = "firebrick", linetype = 2) +
geom_linerange() +
geom_point() +
facet_grid(.~variable, scales = "free_x") +
theme_bw()
hist(ranef(m1)$name$d
)
ranef(m1)$name$d
ranef(m1)$name$d + 0.14852
summary(m1)
#Graph predictions
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
mutate(year = as.Date("2020-11-12") + dec_diff*3652.5) %>%
ggplot(aes(x = year, y = yhat, color = age_group)) +
geom_hline(yintercept = 0, color = "black") +
#geom_line(alpha = .2, aes(group = group)) +
geom_smooth(linewidth = 2) +
theme_bw() +
#facet_wrap(~age_group) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group",
title = "Predicted wave-to-wave change by age group",
subtitle = "Individual question trajectories and overall trajectory") +
scale_color_brewer(type = "qual", palette = 2) +
theme(legend.position = "none")
#Graph predictions
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
mutate(year = as.Date("2020-11-12") + dec_diff*3652.5) %>%
ggplot(aes(x = year, y = yhat, color = age_group)) +
#geom_hline(yintercept = 0, color = "black") +
#geom_line(alpha = .2, aes(group = group)) +
geom_smooth(linewidth = 2) +
theme_bw() +
#facet_wrap(~age_group) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group",
title = "Predicted wave-to-wave change by age group",
subtitle = "Individual question trajectories and overall trajectory") +
scale_color_brewer(type = "qual", palette = 2) +
theme(legend.position = "none")
long_differences
long_difference
long_difference %>%
mutate(date - age)
long_difference %>%
mutate(date - age) %>% View()
long_difference %>%
mutate(cohort = year(date - age)) %>% View()
long_difference %>%
mutate(cohort = year(date) - age) %>% View()
long_difference %>%
mutate(cohort = year(date) - age) %>%
mutate(cohort = cohort - cohort %% 10)
long_difference %>%
mutate(cohort = year(date) - age) %>%
mutate(cohort = cohort - cohort %% 10) %>% View()
cohort_summaries <- long_difference %>%
mutate(cohort = year(date) - age) %>%
mutate(cohort = cohort - cohort %% 10) %>%
mutate(wave_pair = paste(t1, t2, df, sep = "-")) %>%
group_by(wave_pair, name, cohort) %>%
summarise(d = weighted.mean(duration), a = weighted.mean(abs_diff),
date = weighted.mean(date), n = n(), sd = sd(abs_diff)) %>%
#Filtering out bad questions
filter(name != "natpoor",
name != "nathome") %>% ungroup() %>%
mutate(dec_diff = (as.numeric(difftime(date, max(date), units = "days")))/3652.5) %>%
mutate(se = sd/sqrt(n)) %>%
mutate(name = ifelse(name == "nateduc", "natschools", name))
cohort_summaries
#Cohort Model
m2 <- lmer(a ~ d + dec_diff + cohort + dec_diff*cohort +
(1 + d + dec_diff + age_group + dec_diff*age_group|name),
data = cohort_summaries %>% filter(sd > 0), weights = 1/se)
#Cohort Model
m2 <- lmer(a ~ d + dec_diff + cohort + dec_diff*cohort +
(1 + d + dec_diff + cohort + dec_diff*cohort|name),
data = cohort_summaries %>% filter(sd > 0), weights = 1/se)
m2
cohort_summaries <- long_difference %>%
mutate(cohort = year(date) - age) %>%
mutate(cohort = cohort - cohort %% 10) %>%
mutate(wave_pair = paste(t1, t2, df, sep = "-")) %>%
group_by(wave_pair, name, cohort) %>%
summarise(d = weighted.mean(duration), a = weighted.mean(abs_diff),
date = weighted.mean(date), n = n(), sd = sd(abs_diff)) %>%
#Filtering out bad questions
filter(name != "natpoor",
name != "nathome") %>% ungroup() %>%
mutate(dec_diff = (as.numeric(difftime(date, max(date), units = "days")))/3652.5) %>%
mutate(se = sd/sqrt(n)) %>%
mutate(name = ifelse(name == "nateduc", "natschools", name),
cohort = as.factor(cohort))
#Cohort Model
m2 <- lmer(a ~ d + dec_diff + cohort + dec_diff*cohort +
(1 + d + dec_diff + cohort + dec_diff*cohort|name),
data = cohort_summaries %>% filter(sd > 0), weights = 1/se)
cohort_summaries %>%
ggplot(aes(x = year, y = a, color = cohort)) +
geom_smooth()
cohort_summaries
cohort_summaries %>%
ggplot(aes(x = date, y = a, color = cohort)) +
geom_smooth()
View(cohort_summaries)
summaries
#Graph predictions
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
mutate(year = as.Date("2020-11-12") + dec_diff*3652.5) %>%
ggplot(aes(x = year, y = yhat, color = age_group)) +
#geom_hline(yintercept = 0, color = "black") +
#geom_line(alpha = .2, aes(group = group)) +
geom_smooth(linewidth = 2) +
theme_bw() +
#facet_wrap(~age_group) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group",
title = "Predicted wave-to-wave change by age group",
subtitle = "Individual question trajectories and overall trajectory") +
scale_color_brewer(type = "qual", palette = 2) +
theme(legend.position = "none")
#Graph predictions
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
mutate(year = as.Date("2020-11-12") + dec_diff*3652.5) %>%
ggplot(aes(x = year, y = yhat, color = age_group)) +
geom_hline(yintercept = 0, color = "black") +
geom_line(alpha = .2, aes(group = group)) +
geom_smooth(linewidth = 2) +
theme_bw() +
facet_wrap(~age_group) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group",
title = "Predicted wave-to-wave change by age group",
subtitle = "Individual question trajectories and overall trajectory") +
scale_color_brewer(type = "qual", palette = 2) +
theme(legend.position = "none")
summary(m1)
m1
m2 <- lmer(a ~ d + dec_diff + age_group + dec_diff*age_group + d*age_group +
(1 + d + dec_diff + age_group + dec_diff*age_group + d*age_group|name),
data = summaries %>% filter(sd > 0), weights = 1/se)
summary(m2)
BIC(m1)
BIC(m2)
summary(m1)
summary(m2)
# Data to predict
new.data <- expand_grid(age_group = c(unique(summaries$age_group)),
dec_diff = seq(-6.4, 0, by = .1),
d = 0, name = unique(summaries$name))
#Predict data
new.data$yhat <- predict(m2, newdata = new.data)
#Graph predictions
new.data %>%
mutate(group = paste(age_group, name, sep = "-")) %>%
mutate(year = as.Date("2020-11-12") + dec_diff*3652.5) %>%
ggplot(aes(x = year, y = yhat, color = age_group)) +
geom_hline(yintercept = 0, color = "black") +
geom_line(alpha = .2, aes(group = group)) +
geom_smooth(linewidth = 2) +
theme_bw() +
facet_wrap(~age_group) +
labs(x = "Year", y = "Predicted wave-to-wave change",
color = "Age Group",
title = "Predicted wave-to-wave change by age group",
subtitle = "Individual question trajectories and overall trajectory") +
scale_color_brewer(type = "qual", palette = 2) +
theme(legend.position = "none")
new.data
summary(m2)
BIC(m1)
BIC(m2)
m1
summary(m1)
summary(m2)
